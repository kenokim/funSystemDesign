# ch10. 알림 시스템 설계
- Q). 알림 시스템에 큐가 없으면 어떻게 될까? 큐를 사용하는 이유?
- Q). 큐가 알림 타입별로 하나씩 있는데, 만약 하나만 구성한다면 어떤 단점이 있을까?
- Q). kafka 를 사용한다고 하자. consumer 는 뒤의 API 서비스를 호출하고 결과가 나오는 데에는 1분이 걸린다. API 서비스는 최대 동시 처리량 제한이 있으며 서버별로 IP 가 다르고 load balancing 되지 않는다. 이 때, consumer 를 통해 처리량 제한을 어떻게 구성해야 할까?

### 메시지 큐 구조
- 각 알림 매체 별로 큐를 하나씩 구성한다.
- Worker 서버는 각 큐에서 메시지를 구독한다.
  - 각 알림 매체의 처리 속도에 따라 메시지를 처리해야 한다.
  - 

### cf. 웹 크롤러 -> io bound
- i/o bound 애플리케이션을 자바로 개발할 경우, virtual thread 를 쓰면 좋지 않을까 ..
- https://d2.naver.com/helloworld/1203723

## 정확히 한 번(Exactly-Once) 메시지 전달은 불가능하다
- 단, message processing 은 exactly-once 가 가능하다. (kafka 옵션 참고)
- 이 글은 message delivery 에 관한 내용이다.
---

## 1. 분산 시스템에서의 메시지 전달 모델
분산 시스템에서는 다음과 같은 **3가지 메시지 전달 모델**이 존재:
- **최대 한 번(At-Most-Once)**  
  - 메시지가 **최대 한 번** 전달. 메시지 손실 가능.
- **최소 한 번(At-Least-Once)**  
  - 메시지가 **최소 한 번** 전달. 중복 가능.
- **정확히 한 번(Exactly-Once)**  
  - **불가능**.

---

## 2. 왜 Exactly-Once가 불가능한가?
### 2.1 네트워크 및 시스템 장애
- 메시지가 손실되거나 **Ack(확인 메시지)**가 손실될 수 있음.
- 수신자가 메시지를 처리했는지 확인 불가.

### 2.2 이론적 한계
- **Two Generals Problem**  
  - 메시지 전달의 신뢰성 문제.  
- **FLP 정리**  
  - 네트워크에서 장애가 있을 경우, 프로세스 간 합의 불가능.

---

## 3. At-Least-Once 기반의 구현
- **최소 한 번(At-Least-Once)** 전달을 사용하여 **정확히 한 번**을 시뮬레이션:
  1. 메시지 처리 후 **Ack** 전송.
  2. 중복 메시지를 방지하려면 **멱등성(Idempotency)** 또는 **중복 제거(Deduplication)** 필요.

---

## 4. Idempotency(멱등성)란?
- 동일한 작업이 여러 번 수행되어도 시스템 상태에 영향을 주지 않도록 설계.
  - 예: `INSERT` 대신 `UPSERT` 사용.
  - 메시지 처리 결과를 **로그** 또는 **DB**에 저장해 중복 방지.

---

## 5. 설계 시 트레이드오프
- **속도 vs. 일관성**  
  - 정확한 메시지 전달을 보장하려면 **높은 비용(지연, 복잡성)** 발생.  
  - **At-Least-Once** 모델로 복원력과 성능 최적화.

---

## 6. 결론
- **Exactly-Once**는 이론적 허상.
- **At-Least-Once**와 **Idempotency**를 활용해 **신뢰성**과 **일관성** 확보.
- 분산 시스템 설계 시 **장애 허용**과 **비동기적 특성**을 고려해야 함.
