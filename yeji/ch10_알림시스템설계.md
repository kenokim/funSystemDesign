# 10장 알림 시스템 설계

- 고객에게 중요할만한 정보를 비동기적으로 전달, 모바일푸시/SMS메세지/이메일
- 알림종류/지원단말/생성주체/최대건수
    - ios/andriod
        - 알림제공자 →APNS/FCM → 단말
        - 알림 제공자 : 알림요청(단말토큰,페이로드)을 만들어 애플푸시알림서비스(APNS)로 전송
        - APNS : 애플이 제공, 푸사일림을 ios장치로 보냄
        - FCM : 파이어베이스 클라우드 메세징
    - SMS
        - 알림제공자 → SMS서비스 →단말
        - 트윌리오, 넥스모같은 3자 사업자 서비스 사용
    - 이메일
        - 알림제공자 → 이메일서비스 → 단말
        - 고유 이메일 서버나 상용 이메일 서비스 이용 ( 샌드그리드,메일침프- 데이터분석서비스도 제공)
    - 연락처 정보 수집
        - 계정 등록시 단말토큰,저노하번호,이메일 주소등을 수집, 단말은 여러개일 수 있음
- 알림 전송 및 수신 절차
    - 1차
        - 서비스 : 각각의 서비스는 마이크로서비스/크론잡/컴포넌트 등일 수 있음(과금,배송 등)
        - 알림 시스템 : 알림 시스템은 1개라고 가정, 알림 전송 api와 페이로드 생성 필요
            - SPOF : single point of failure 전체 서비스의 장애로 이어짐.
            - 규모 확장성 : 데이터 베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없음
            - 성능 병목 : 알림은 많은 자원필요(html페이지 생성, 3자 서비스 응답대기 등)
        - 3자 서비스: 3사 서비스로 실제 알림 전달 , 확장성이 중요, 서비스 사용이 국가 등에 따라 불가능 할 수도 있음
    - 개선
        - 알림 시스템
            - 데이터 베이스와 캐시 분리
            - 알림서버
                - 알림전송 api : 인증 필요
                - 알림 검증 : 내용 검증
                - 데이터베이스 질의 : 알림 내용을 위함
                - 알림 전송 : 알림 데이터를 메세키 큐에 넣는다
                - 알림 서버의 수평적 규모 확장 지원
        - 메세지 큐를 이용한 컴포넌트 사이의 결합 제거, 다량발생시 버퍼 역할
        - 작업 서버 : 메세지 큐에서 전송할 알림을 꺼내서 제 3자 서비스로 전달
- 안정성
    - 알림이 소실되면 안됨. 알림 데이터를 데이터베이스에 보관하고 재시도 매커니즘을 구현해야한다. → 알림 로그 디비 구현
    - 알림 중복 전송 방지 : 보내야하는 알림 이벤트 id를 검사하여 중복 판단
        - https://bravenewgeek.com/you-cannot-have-exactly-once-delivery/
        - 분산 시스템에서는 정확히 한 번 전달을 보장할 수 없음
        - 대부분의 경우 '최소 한 번' 전달 방식을 선택하고, 이를 바탕으로 멱등성이나 부작용 제거를 통해 정확히 한 번 전달된 것처럼 시뮬레이션함
- 추가로 필요한 컴포넌트 및 고려 사항
    - 알림 템플릿 : 알림형식 일고ㅛㅏㄴ성 유지 및 오류,시간 감소
    - 알림 설정 : 개인 설정
    - 전송률 제한 : 사용자가 받을 수 있는 알림 빈도 제한 ( 알림 해제 방지)
    - 재시도 매커니즘 : 재시도 전용 큐, 반복시 개발자에게 알림
    - 보안 : 인증된 클라이언트만 알림 전송 , 모바일은 appkey appsecret 사용
    - 알림 큐 모니터링 : 큐에 쌓인 알림의 갯수를 보고 서버 증설
    - 이벤트 추적 : 알림 확일율, 클릭율, 실제 사용으로 이어지느 비율
