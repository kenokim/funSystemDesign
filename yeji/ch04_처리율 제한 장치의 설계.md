- 처리율 제한 장치(rate limiter) : 네트워크 시스템에서 처리율 제한 장치를 클라/서버가 보내는 트래픽의 처리율을 제어하기 위한 장치
    - http는 요청 횟수를 제한.
- 장점
    - dos 공격에 의한 자원 고갈 방지 ( read 요청 제한, 게시글 업로드 수 제한)
    - 비용 절감 - 서버를 많이 두지 않을수있음, 우선순위가 높은 api에 더많은 자원 할당, 서드파티 호출 시 제한을 통해 비용 절감 가능
    - 서버 과부하 방지 - 봇,사용자의 잘못된 패턴으로 유발된 트래픽 블락
- 요구사항
    - 분산형 처리율 제한, 대규모
    - 예외 처리된 경우 사용자에게 안내.
- 처리율 제한 장치 위치
    - 클라이언트 : 보통 안정적으로 제한하지 못하고 위변조가 쉽게 가능함
    - 서버: 제한 장치를 둠
    - 미들웨어: 미들웨어를 만들어 api 서버로 가는 요청을 통제(429반환) → 주로 api gateway 가 담당
        - 처리율 제한, SSL 종단, 사용자인증, IP 허용목록관리 등을 지원하는 위탁 관리형 클라우드 서비스 사용
            
            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/bd45c031-0556-4266-9d71-978802c60201/image.png)
            
        - 프로그래밍 언어, 처리율 알고리즘, 기존 시스템 구조, 인력을 고려하여 설계
- 처리율 제한 알고리즘
    - 토큰 버킷 (아마존,스트라이프)
        - 토큰 버킷은 지정된 용량을 갖는 컨테이너. 사전 설정된 양이 넘으면 더이상의 토큰이 추가되지 않고 버려짐
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/512d03fd-d887-46a9-b8fc-5e193470106d/image.png)
        
        - 인자 : 버킷크기, 토큰공급률(초당 토큰 공급갯수)
        - 버킷 갯수 : 통상적으로 api 엔드포인드 마다 별도의 버킷을 둠( 포스팅,친구,좋아요별 / ip별 / 공통 등)
        - 장점 : 구현이 쉽고 메모리사용이  효율적, 짧은시작에 집중되는 트래픽도 처리 가능
        - 단점 : 인자 튜닝이 어려움
    - 누출 버킷 알고리즘(쇼피파이)
        - 요청이 도착하면 큐가 가득 차있는지 보고 가득찬경우 새요청은 버림, 빈경우 큐에 추가. 지정된 시간마다 큐에서 요청을 꺼내서 처리한다 (FIFO)
            
            ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/db57d1b2-15c3-4298-8309-556f273cca0f/image.png)
            
        - 인자 : 버킷크기(큐사이즈), 처리율(지정된 시간당 몇개의 항목을 처리할지,초당)
        - 장점 : 큐의 크기가 제한되어 있어 메모리 측면에서 효율적, 고정된처리율을 가져 안정적출력을 가짐
        - 단점 : 단시간에 많은 트래픽이 몰리면 오래된 요청이 쌓여 최신요청이 버려짐. 인자 튜닝이 이려움
    - 고정 윈도 카운터 알고리즘
        - 타임라인을 고정된 간격의 윈도우로 나누고 각 윈도우마다 카운터를 두어 요청이 접수될 때마다 1씩 증가. 임계치에 도달하면 새로운 요청은 새 윈도우가 열릴떄까지 버려짐
        - 카운터
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/780d4ba3-25ec-488c-a1d5-87db4b84f6eb/image.png)
        
        - 단점 : 윈도우 경계에 트래픽이 몰릴경우 할당된 양보다 많은 요청이 처리될 수 있음
        - 장점 : 메모리 효율, 이해하기쉬움. 트래픽패턴에 적함
    - 이동 윈도 로깅 알고리즘
        - 요청의 타임스탬프를 추적( 레디스의 sorted set 등과같은 캐시) , 만료된 타임스탬프는 제거(위도의 시작 시점보다 오래된 경우) , 새 요청의 타임스탬프를 로그에 추가, 로그의 크기가 작으면 전달, 아닌경우 버림
        - 분당 처리량 제한값
        - 장점 - 정교함
        - 단점 - 메모리를 많이 사용함
    - 이동 윈도 카운터 알고리즘
        - 위 두개를 결합.
        - 현재 1분간의 요청수 + 직전 1분간의 요청수 * 이동윈도와 직전1분이 겹치는 비율을 처리율 제한 한도와 비교
        - 장점 - 메모리 효율이 좋음, 짧ㅅ은시간에 몰리는 트래픽에 대응 가능함
        - 단점 - 균등한 상태를 가정하고 있기에 다소 느슨함( 더많이 허용됨)
    - INCR : 메모리에 저장된 카운터를 증가 / EXPIRE  카운터에 타임아웃 값 설정
    - EXPIRE : 카운터에 타임아웃 값 설정
    
    ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/b79beb78-3124-489d-975d-bb0b04c1dee1/image.png)
    
- 상세 설계
    - 처리율 제한 규칙 저장& 생성
        - 보통 설정파일 형태로 디스크에 저장
    - 제한된 요청 처리
        - 429 응답 / 보관했다가 처리 등..
        - 응답 헤더에 정보 추가
            - X-Ratelimit-Remaining: 윈도 내에 남은 처리 가능 요청의 수.
            - X-Ratelimit-Limit: 매 완도마다 클라이언트가 전송할 수 있는 요청의 수.
            - X-Ratelimit-Retry-After: 한도 제한에 걸리지 않으려면 몇 초 뒤에 요청을 다 시 보내야 하는지 알림.
    - 미들웨어가 제한규칙을 캐시에서 가져오고 요청으 ㅣ타임스탬프도 가져옴.
        
        ![image.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/59a94395-18fc-496f-bddd-69dc0359c611/05f05719-ae62-4e4c-adb4-e353632245ad/image.png)
        
- 분산환경에서 처리율 제한 장치의 구현
    - 경쟁조건/ 동기화 고려
    - 경쟁 조건 - 락은 성은 저하, 루아스크립트/ 정렬집합을 통해 해결
    - 동기화 - 한대로 충분하지 않은경우 처리율 제한 장치를 여러대 둘때 문제. - 고정세션 ( 항상같은 처리율 제한 장치로), 레디스와같은 중앙집중형 데이터 저장소
- 성능 최적화
    - 경성/연성 처리율
    - 다양한 계층에서의 처리율
    - 처리율 제한 회피
- 모니터링
    - 알고리즘과 규칙을 모니터링하여 변경
