알림 시스템은 고객에게 중요할 만한 정보를 비동기적으로 제공한다.

알림 시스템은 단순히 모바일 푸시 알림(mobile push notification)에 한정되지 않는다.

모바일 푸시 알림, SMS 메세지, 이메일 세가지로 분류할 수 있다.

### 1단계 문제 이해 및 설계 범위 확정

하루 백만건 이상의 알림을 처리하는 확장성 높은 시스템을 구축하는 것은 쉬운 과제는 아니다.

정해진 정답이 없고, 문제 자체가 모호하게 주어지는 것이 일반적이므로, 적절한 질문을 통해 요구사항이 무엇인지 지원자 스스로 알아내야 한다.

요구사항을 명확하게 하기 위해서 할 수 있는 질문 목록

- 어떤 종류의 알림을 지원해야하는지?
- 실시간(real-time)시스템이어야하는지?
- 어떤 종류의 단말을 지원해야하는지?
- 사용자에게 보낼 알림을 누가 알림을 만들 수 있는지?
- 사용자가 알림을 받지 않도록 설정 가능해야 하는지?
- 하루 몇 건의 알림을 보낼 수 있어야 하는지?

### 2단계 개략적 설계안 제시 및 동의 구하기

**알림 유형별 지원 방안**

각 알림 메커니즘이 어떻게 동작하는지 먼저 살펴보자.

- IOS 푸시 알림
    - APNS(Apple Push Notification Service)
- 안드로이드 푸시 알림
    - FCM(Firebase Cloud Messaging)
- SMS 메세지
    - 트윌리오(Twilio), 넥스모(Nexmo)
- 이메일
    - 센드그리드(Sendgrid), 메일침프(Mailchimp)

**연락처 정보 수집 절차**

앱을 설치하거나 처음으로 계정을 등록하면 API서버는 해당 사용자의 정보를 수집하여 데이터베이스에 저장한다.

하나의 계정에서 여러 디바이스에 알림이 갈 수 있다는 점을 고려할 필요가 있다.

**알림 전송 및 수신 절차**

개략적 설계안부터 점차 최적화해 나가도록 할 것 이다.

개략적 설계안(초안)

해당 설계안에서는 몇 가지 문제가 있다.

- SPOF(Single Polint Of Failure)
    
    알림 서비스에 서버가 하나 밖에 없다는 것, 해당 서버의 장애가 생기면 전체 서비스의 장애로 이어짐.
    
- 규모 확장성
    
    한 대 서비스로 푸시 알림에 관계된 모든 것을 처리하므로 데이터 베이스나 캐시 등 중요 컴포넌트의 규모를 개별적으로 늘릴 방법이 없다.
    
- 성능 병목
    
    알림을 처리하고 보내는 것은 자원을 많이 필요로 하는 작업일 수 있다.
    
    모든 것을 한 서버에서 처리하면 사용자 트래픽이 많이 몰리는 시간에는 시스템이 과부하 상태에 빠질 수 있다.
    

### 3단계 상세 설계

다음 내용을 좀 더 자세히 알아볼 것이다.

**안정성(reliability)**

분산 환경에서 운영될 알림 시스템을 설계할 때는 안정성을 확보하기 위한 사항 몇 가지를 반드시 고려해야한다.

- **데이터 손실 방지**
    
    어떤 상황에서도 알림이 소실되며 안된다는 것
    
    알림 시스템은 알림 데이터를 데이터베이스에 보관하고 재시도 메커니즘을 구현해야한다.
    
    → 알림 로그(notification log) 데이터베이스를 유지하는 것이 한 가지 방법이다.
    
- 알림 중복 전송 방지
    
    같은 알림이 여러번 반복되는 것을 완전히 막는 것은 가능하지 않다.
    
    분산 시스템 특성상 가끔은 같은 알림이 중복되어 전송되기도 할 것이다.
    
    빈도를 줄이기 위해서는 탐지하는 메커니즘으 도입하고 오류를 신중하게 처리해야 한다.
    
    → 보내야 할 알림이 도착하면 그 이벤트 ID를 검사하여 이전에 본 적이 있는 이벤트인지 살핀다. 만약 중복된 알림이라면 버리고, 그렇지 않으면 알림을 발송한다.
    

**추가로 필요한 컴포넌트 및 고려사항**

알림 시스템을 구현을 위한 추가 컴포넌트들

- 알림 템플릿
    
    대형 알림 시스템은 하루에도 수백만 건 이상의 알림을 처리한다.
    
    대부분 알림 메시지의 형식이 비슷하다.
    
    따라서 알림 템플릿은 인자(parameter)나 스타일, 추적 링크(tracking link)를 조정하기만 하면 사전에 지정한 형식에 맞춰 알람을 만들어 내는 틀이다.
    
    템플릿을 사용하면 전송될 알림의 형식을 일관성 있게 유지 가능하고, 오류 가능성뿐 아니라 알림 작성에 드는 시간도 줄일 수 있다.
    
- 알림 설정
    
    사용자는 이미 많은 알림을 받고 있어서 쉽게 피곤함을 느낀다.
    
    따라서 알림 설정을 상세히 조정할 수 있도록 하고 있다.
    
    특정한 알림을 보내기 전에 반드시 해당 사용자가 해당 알림을 켜두었는지 확인해야 한다.
    
- 전송률 제한
    
    너무 많은 알림을 보내지 않도록 하는 한 가지 방법은 한 사용자가 받을 수 있는 알림의 빈도를 제한하는 것이다.
    
    이것이 중요한 이유는 알림을 너무 많이 보내기 시작하면 사용자가 알림 기능을 아예 꺼버릴 수도 있기 때문이다.
    
- 재시도 방법
    
    알림 전송에 시패하면 해당 알림을 재시도 전용 큐에 넣는다. 같은 문제가 지속 발생하면 개발자에게 통지한다.
    
- 푸시 알림과 보안
    
    알림 전송 API는 appKey와 appSecret을 사용하여 보안을 유지한다.
    
    따라서 인증된(authenticated) 혹은 승인된(verifie) 클라이언트만 해당 API를 사용하여 알림을 보낼 수 있다.
    
- 큐 모니터링
    
    알림 시스템 모니터링 시 중요한 메트릭(metric) 하나는 큐에 쌓인 알림의 개수이다.
    
    이 수가 너무 크면 작업들이 이벤트를 빠르게 처리하고 있지 못하다는 뜻이다.
    
- 이벤트 추적
    
    알림 확인율, 클릭율, 실제 앱 사용으로 이어지는 비율 같은 메트릭은 사용자를 이해하는데 중요하다.
    
    데이터 분석 서비스(analystics)는 보통 이벤트 추적 기능도 제공한다.
    

**수정된 설계안**

- 알림 서버에 인증(authentication)과 전송률 제한(rate-limiting) 기능이 추가됨.
- 전송 실패 에 대응하기 위한 재시도 기능이 추가되었다.
- 전송 템플릿을 사용하여 알림 생성 과정을 단순화하고 알림 내용의 일관성을 유지한다.
- 모니터링과 추적 시스템을 추적하여 시스템의 상태를 확ㅇ니하고 추후 시스템을 개선하기 쉽도록 하였다.
