### 설계 목표

- 기능
    - URL 단축 : 주어진 긴 URL을 훨씬 짧게 줄여준다.
    - URL 리디렉션 (redirection) : 축약된 URL로 HTTP 요청이 오면 원래 URL로 안내
    - 높은 가용성과 규모 확장성, 그리고 장애 감내가 요구됨
- 계략적 추정
    - 쓰기 연산 : 매일 1억개의 단축 URL 생성
    - 초당 쓰기 연산 : 1억 / 24 / 3600 = 1160
    - 읽기 연산 : 읽기 연산과 쓰기 연산의 비용을 10:1이라고 가정, 초당 11600회
    - URL 단축 서비스를 10년간 운영한다고 가정, 1억 * 365 *10 = 3650개 렉코드 보관 필요
    - 축약 전 URL의 평균 길이는 100이라고 가정
    - 10년 동안 필요한 저장 용량, 3650억 * 100 바이트 = 36.5TB

---

### API 엔드 포인트

REST 스타일로 설계한다고 가정하고 설계하는 경우, 기본적으로 아래 두 개의 엔드포인트가 필요하다.

- URL 단축용 엔드포인트 : 클라이언트에서 새 단축 URL을 생성하고자 하는 URL을 실어서 POST 요청을 보내야한다.
- URL 리디렉션용 엔드포인트 : 단축 URL에 대해서 HTTP 요청이 오는 경우 원래 URL로 보내주기 위한 용도의 엔드포인트

### URL 리디렉션

단축 URL을 받은 서버는 원래 URL로 바꾸어서 301로 응답을 한다.

- 301과 302 응답 차이
    - 301 Permanently Moved : http 요청의 처리 책임이 영구적으로 location 헤더에 반환된 url로 이전되었다는 응답.
        
        영구 이전이라는 응답이기 때문에 브라우저는 해당 응답을 캐시해두고, 브라우저는 캐시된 원래 url로 요청을 보내게 된다.
        
    - 302 Found : 일시적으로 location 헤더가 지정하는 url에 의해 처리 되어야 한다는 응답.
        
        클라이언트의 요청은 언제나 단축 url 서버에먼저 보내진 후에 원래 url로 리디렉션 된다.
        
- 301, 302 응답의 장단점
    - 서버 부하를 줄이고자 - 301 응답
    - 트래픽 분석이 중요한 경우 - 302 응답

URL 리디렉션을 구현하는 가장 직관적인 방법은 해시 테이블을 사용하는 것 ex) <단축 URL, 원래 URL>

### URL 단축

중요한 것은 긴 URL을 해시 값으로 대응 시킬 해시 함수를 찾는 일이다.

- 해시 함수의 조건
    - 입력으로 주어지는 긴 URL이 다른 값이면 해시 값도 달라야 한다.
    - 계산된 해시 값은 원래 입력으로 주어졌던 긴 URL로 복원될 수 있어야 한다.

---

아래 부터는 데이터 모델, 해시 함수, URL 단축 및 리디렉션에 관한 구체적인 설계안

### 데이터 모델

개략적인 설계에서는 모든 것을 해시 테이블에 두었는데 이는 실제 시스템에 쓰기는 곤란하다. 메모리는 유한하고 비싸기 때문이다.

<단축 URL, 원래 URL>의 순서쌍을 관계형 데이터베이스에 저장하는 것이 더 나은 방향이다.

### 해시 함수

해시 함수는 원래 URL을 단축 URL로 변환하는데 쓰인다.

- 해시 값 길이
    - [0-9, a-z, A-Z]로 이루어진 URL이기 때문에 사용할 수 있는 문자 갯수 : 62개
    - 현재 가정에서는 3650억개의 URL을 만들 수 있어야한다.
    - 62^n ≥ 3650억인 n의 최소값을 찾아야한다. n이 7이면 3.5조이기 때문에 길이는 7로 선정.
- 해시 후 충돌 해소
    - 길이가 7인 문자열로 줄이는 해시 함수가 필요하다.
    - 쉬운 방법은 CRC32, MD5, SHA-1과 같이 잘 알려진 함수를 사용
    - CRC32가 계산한 가장 짧은 해시값 조차도 7보다 길다. 이는 어떻게 해결해야할까?
        
        → 처음 7개 글자만 사용 → 해시값 충돌 확률이 높아진다 → 충돌 해소될 때까지 사전에 정한 문자열을 해시값에 덧붙인다. 
        ⇒ 해당 방법은 충돌은 해소되지만 한번 이상 데이터베이스에 질의해야 하므로 오버헤드가 크다.
        
        ⇒ 데이터베이스 대신 **블룸 필터**를 쓰면 성능을 높일 수 있다.
        
- base-62 변환
    
    진법 변환(base conversion)은 URL 단축키를 구현할 때 흔히 사용되는 접근법 중 하나이다.
    
    해당 기법은 수의 표현 방식이 다른 다른 두 시스템이 같은 수를 공유하여야 하는 경우 유용.
    
    62 진법을 쓰는 이유는 hashValue에 사용할 수 있는 문자(character) 개수가 62개이기 때문
    
- 두 접근 법 비교

### URL 단축기 상세 설계

- 입력된 URL에 대해 ID 생성기가 반환한 ID값을 만든다.
- 해당 ID를 62진수로 변환하여 값을 얻는다.
- 새로운 데이터베이스 레코드를 만든다.
- 로드 밸런서의 동작 흐름
    1. 사용자가 단축 URL을 클릭
    2. 로드밸런서가 해당 클릭으로 발생한 요청을 웹 서버에 전달
    3. 단축 URL이 이미 캐시에 있는 경우에는 원래 URL을 바로 꺼내서 클라이언트에게 전달.
    4. 캐시에 해당 단축 URL이 없는 경우에는 데이터베이스에서 꺼낸다. 데이터 베이스에 없다면 아마 사용자가 잘못된 단축 URL을 입력한 경우일 것이다.
    5. 데이터 베이스에서 꺼낸 URL을 캐시에 넣은 후 사용자에게 반환한다.

### 추가적으로 이야기 나눌 수 있는 주제

- 처리율 제한 장치
- 웹 서버의 규모 확장
- 데이터 베이스의 규모 확장
- 데이터 분석 솔루션
- 가용성, 데이터 일관성, 안정성

---
### 블룸 필터?

원소가 집합에 속하는지 여부를 검사하는데 사용되는 확률적 자료 구조
## **실무에서의 URL 단축기 사용 사례**

### **마케팅 및 광고 캠페인**

- **캠페인 추적**: 각 마케팅 채널에 고유한 단축 URL을 제공하여 클릭 수, 전환율을 측정합니다.
- **소셜 미디어**: 트위터나 인스타그램처럼 글자 수 제한이 있는 플랫폼에 긴 URL 대신 단축 URL을 사용합니다.

### **브랜드 URL 단축**

- **브랜드 신뢰도 향상**: `yourbrand.co/abc123`와 같은 맞춤형 단축 URL을 사용해 브랜드 일관성을 유지합니다.

### **내부 시스템 관리**

- **내부 문서 및 리소스 공유**: 복잡한 URL 대신 단축 URL로 사내 리소스 접근을 쉽게 합니다.
- **API 단축**: REST API 엔드포인트 URL을 간략하게 표시할 때 활용할 수 있습니다.

### **리포트 및 분석**

- **데이터 수집 및 분석**: 단축 URL의 클릭 로그를 통해 사용자 행동 데이터를 수집하고 분석합니다.
