수평적 규모 확장성을 달성하기 위해서는 요청 또는 데이터를 서버에 균등하게 나누는 것이 중요하다.

안정 해시는 이 목표를 달성하기 위해서 보편적으로 사용하는 기술이다.

### 해시 키 재배치(refresh) 문제

N개의 캐시 서버가 있을 경우, 부하를 균등하게 나누는 보편적인 방법은 해시 함수를 사용하는 것이다.

serverIndex = hash(key) % N (N은 서버의 개수)

서버 풀(server pool)의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 동작한다.

하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 발생한다.

만약 하나의 서버가 죽는다면 장애가 발생한 키 뿐만 아니라 대부분의 키가 재분배된다.

그 결과 대규모 캐시 미스(cache miss)가 발생하게 되고, 안정 해시는 이 문제를 효과적으로 해결하는 기술이다.

### 안정 해시

‘안정 해시(consistent hash)’는 테이블 크기가 조정될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다. 이때, k는 키의 개수, n은 슬롯(slot)의 개수이다.

### 해시 공간과 해시 링

sha-1을 사용한다고 가정했을 때, 해시 공간 (hash space) 범위는 0부터 2^160-1까지라고 알려져 있다.

이 공간을 양쪽을 구부려 접으면 그림 5-4와 같은 해시 링(hash ring)이 만들어진다.

### 안정 해시 알고리즘

기본 절차

- 서버와 키를 균등 분포(uniform distribution) 해시 함수를 사용해 해시 링에 배치한다.
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초 서버가 키가 저장될 서버이다.

문제점

- 서버가 추가되거나 삭제되는 상황을 감안하면 파티션(partition)의 크기를 균등하게 유지하는게 불가능하다는 것
- 키의 균등 분포(uniform distribution)을 달성하기가 어렵다는 것

→ 해당 문제점을 해결하기 위해 제안된 기법으로 **가상 노드 (virtual node)** 또는 **복제(replica)**라고 불리는 기법이 있다.

### 가상 노드

가상 노드(virtual node)는 실제 노드 또는 서버를 가리키는 노드이다.

하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.

즉, 각 서버는 하나가 아닌 여러 개 파티션을 관리해야 한다.

### 안정 해시 이점

- **재배치 최소화**: 서버가 추가되거나 제거될 때, 재배치되는 키의 수가 최소화되어 시스템의 안정성과 효율성이 향상됩니다.
- **균등한 데이터 분포**: 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다.
- 가상 노드를 사용하면 데이터가 보다 균등하게 분포되어, 서버 간 부하가 고르게 분산됩니다.
- **핫스팟 문제 감소**: 안정 해시는 데이터를 좀 더 균등하게 분배하므로, 특정 서버에 대한 과도한 접근으로 인한 핫스팟 문제를 줄일 수 있습니다.

---

### **안정 해시 기반 시스템에서 특정 노드로 데이터가 몰리는 문제가 발생한다면?**

**답변**:

데이터가 특정 노드로 몰리는 현상은 **데이터 불균형** 문제로 이어질 수 있습니다. 이를 해결하기 위한 접근법은 다음과 같습니다:

1. **가상 노드 추가**:
    - 노드마다 가상 노드를 다수 생성해 데이터 분포를 고르게 만듭니다.
2. **해시 함수 변경**:
    - 분포가 더 균등한 해시 함수를 선택.
    - 예: MurmurHash 또는 SHA-256.
3. **노드의 가중치 조정**:
    - 노드의 처리 능력에 따라 가상 노드의 수를 조정.
    - 예: 고성능 서버에는 더 많은 가상 노드를 매핑.

**예제**:

Redis 클러스터에서 **`--cluster-rebalance`** 명령을 사용해 데이터 재분배.

**결과**:

이러한 방법을 통해 트래픽과 데이터가 고르게 분산됩니다.

### **안정 해시와 다른 로드 밸런싱 알고리즘의 차이를 설명해주세요.**

**답변**:

안정 해시는 **데이터 분산**에 초점을 맞추고 있으며, 특정 키가 항상 동일한 노드로 매핑되도록 설계되었습니다.

반면, 일반적인 로드 밸런싱 알고리즘(라운드 로빈, 최소 연결 등)은 **요청 분산**에 중점을 둡니다.

**비교**:

- 안정 해시:
    - 사용 사례: 데이터 저장 시스템(예: Cassandra, DynamoDB).
    - 주요 장점: 데이터 이동 최소화, 세션 지속성 유지.
- 라운드 로빈/최소 연결:
    - 사용 사례: 웹 서버 트래픽 분산(예: Nginx, HAProxy).
    - 주요 장점: 실시간 요청 균형 유지, 간단한 구현.

안정 해시는 데이터 중심 시스템에서 더 적합합니다.

### **안정 해시의 성능 문제를 개선하려면?**

**답변**:

안정 해시에서도 성능 문제(예: 데이터 불균형, 해시 충돌)가 발생할 수 있습니다. 이를 해결하기 위한 방법은 다음과 같습니다:

1. **가상 노드(Virtual Node) 사용**:
    - 각 노드에 여러 개의 가상 노드를 매핑하여 데이터 분배를 더 균등하게 만듭니다.
    - 예: 1개의 실제 노드에 100개의 가상 노드를 매핑.
2. **해시 함수 최적화**:
    - 해시 값의 균등 분포를 보장하는 **SHA-256** 또는 **MD5**와 같은 크립토그래픽 해시 함수 사용.
3. **적응형 해시링(Adaptive Hash Ring)**:
    - 노드의 가중치 또는 처리 성능을 고려해 동적으로 데이터 분배.

**결과**:

가상 노드와 적절한 해시 함수를 사용하면 데이터 불균형 문제를 효과적으로 해결할 수 있습니다.

### **안정 해시를 사용하는 시스템 설계를 설명해주세요.**

**답변**:

안정 해시를 사용하는 분산 캐시 시스템을 설계해 보겠습니다:

1. **요구사항 정의**:
    - 노드 추가/제거가 빈번하며 데이터 이동을 최소화해야 함.
    - 캐시 데이터의 세션 일관성을 유지해야 함.
2. **구조**:
    - 클라이언트는 요청 키의 해시 값을 계산하여 안정 해시를 기반으로 노드를 선택.
    - 노드는 원형 해시 링에 매핑되며, 각 데이터는 가장 가까운 노드로 할당.
    - 노드 추가/제거 시 영향을 받는 데이터만 재배치.
3. **기술 구현**:
    - 노드 수가 적을 경우 데이터 불균형을 해결하기 위해 **가상 노드(Virtual Node)**를 추가.
    - Redis 또는 Memcached의 클러스터링에 적용 가능.

**결과**:

이런 설계는 데이터 이동을 줄이면서 높은 가용성과 확장성을 제공합니다.

### **안정 해시를 사용하지 않는 경우 어떤 문제가 발생할 수 있나요?**

**답변**:

안정 해시를 사용하지 않으면 일반적으로 **모듈러 해시** 방식을 사용하게 됩니다. 예를 들어 **`hash(key) % N`**으로 데이터를 분산하는 경우를 생각할 수 있습니다.

그러나 노드가 추가/제거되면 **`N`**값이 바뀌면서 대부분의 데이터가 새 노드로 매핑되어야 합니다.

이는:

- **대규모 데이터 이동**: 시스템에 과부하를 유발.
- **캐시 미스(Cache Miss)**: 캐시 사용 시, 기존 데이터가 모두 사라져 성능 저하를 초래.

반면 안정 해시는 데이터 재배치를 최소화하여 위 문제를 방지합니다.

### **안정 해시란 무엇이며, 어떻게 작동하나요?**

**답변**:

안정 해시는 분산 시스템에서 데이터와 노드(서버)를 매핑하는 알고리즘으로, 노드가 추가되거나 제거될 때 데이터 재배치의 영향을 최소화합니다.

기본 아이디어는 **해시 링(Hash Ring)**을 사용하는 것입니다.

- 데이터와 노드는 동일한 해시 함수로 0부터 1 사이의 값으로 변환되어 원형 링에 매핑됩니다.
- 각 데이터는 해시 값이 자신보다 **가장 가까운 노드(시계 방향)**로 매핑됩니다.
- 노드가 추가되면 해당 노드의 해시 값보다 큰 데이터만 재배치되며, 기존 노드의 데이터 대부분은 유지됩니다.

**장점**:

- 서버 추가/제거 시 데이터 이동이 최소화됨.
- 동적 확장이 용이함.

**예제**: Redis 클러스터나 Cassandra에서 데이터를 분산 저장할 때 사용됩니다.
