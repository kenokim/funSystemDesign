
### Discord가 선형 캐시를 사용한 방법

즉, 분산 시스템에서 각 엔티티가 어느 노드에 있는지 빠르게 찾기 위해 링 데이터 구조를 사용했다는 것입니다. 이를 통해 사용자가 접속할 때 해당 사용자가 속한 길드(서버)를 빠르게 찾을 수 있었습니다.

이 문서에 따르면 Discord는 자신들의 링 데이터 구조에서 값을 조회하는 성능을 개선하기 위해 FastGlobal이라는 선형 캐시를 사용했습니다.

>연구 끝에 우리는 mochiglobal이라는 모듈을 발견했는데, 이는 VM의 특정 기능을 활용합니다. 즉, Erlang이 항상 같은 상수 데이터를 반환하는 함수를 보면 그 데이터를 프로세스가 복사 없이 접근할 수 있는 읽기 전용 공유 힙에 넣어둡니다. mochiglobal은 이 기능을 이용해 런타임에 하나의 함수를 가진 Erlang 모듈을 만듭니다. 데이터가 복사되지 않으므로 조회 비용이 0.3μs로 줄어들어 전체 시간이 **750ms**까지 단축되었습니다.

핵심 이유는 ETS에 큰 링 데이터 구조를 복사하고 다시 읽어오는 데 드는 비용이 대부분을 차지했기 때문입니다. FastGlobal은 mochiglobal의 Elixir 버전으로, 읽기 전용 공유 힙에서 데이터를 직접 접근할 수 있게 해 거의 비용이 들지 않는 조회가 가능했습니다.

#### ETS?
ETS(Erlang Term Storage)는 Erlang에서 제공하는 빠른 mutable 딕셔너리 구현체입니다.
문서에 따르면 Discord는 처음에 ETS를 사용해 성능 향상을 시도했지만, 문제가 있었습니다

The first thing people do in Elixir when they want to speed up data access is to introduce ETS. ETS is a fast, mutable dictionary implemented in C; the tradeoff is that data is copied in and out of it. We couldn't just move our ring into ETS because we were using a C port to control the ring, so we converted the code to pure Elixir.

즉, ETS에 데이터를 복사하고 다시 읽어오는 비용이 문제가 되었고, 링 데이터 구조가 크기 때문에 이 비용이 대부분을 차지했다는 것입니다. 그래서 결국 FastGlobal을 사용해 읽기 전용 공유 힙에서 직접 데이터를 읽는 방식으로 해결했습니다.


알겠습니다. ETS는 Erlang에서 제공하는 빠른 데이터 저장소입니다. 

Discord에서는 처음에 ETS를 사용해서 데이터 접근 속도를 높이려고 했습니다. ETS는 C로 구현된 빠른 사전 자료구조이지만, 데이터를 ETS에 저장하고 다시 읽어오는 과정에서 비용이 발생합니다.

Discord에서 사용하는 링 데이터 구조가 크기 때문에, ETS에 저장하고 읽어오는 비용이 전체 성능의 대부분을 차지했습니다. 그래서 Discord는 FastGlobal이라는 새로운 방식을 사용했습니다.

FastGlobal은 Erlang의 특별한 기능을 이용해서, 데이터를 읽기 전용 공유 메모리 영역에 저장합니다. 이렇게 하면 데이터를 복사하지 않고 바로 접근할 수 있어서 성능이 크게 향상되었습니다.







## 핫스팟 이슈

### **핫스팟 문제의 해결 방안**

1. **가상 노드 사용**
    
    - 각 물리적 노드를 여러 개의 가상 노드로 분할해 해시 공간에 고르게 배치하여 데이터 불균형을 완화합니다.
2. **해시 함수 개선**
    
    - 해시 함수의 분포 특성을 분석하여 더 균등하게 데이터를 분배할 수 있는 함수를 선택합니다.
3. **노드 자원 조정**
    
    - 노드의 처리 능력에 따라 가중치를 부여하거나 더 많은 가상 노드를 할당하여 부하를 분산합니다.
4. **캐싱 계층 도입**
    
    - 핫스팟이 발생할 가능성이 높은 데이터를 캐싱 계층에 저장해 부하를 분산합니다.
5. **요청 라우팅 최적화**
    
    - 핫스팟을 감지하여 요청을 다른 노드로 분산시키는 로드 밸런싱 전략을 도입합니다.


### 핫스팟 이슈 감지 방법
핫스팟 문제를 감지하기 위해 다양한 모니터링 기법과 지표를 활용할 수 있습니다. 아래는 일반적인 핫스팟 감지 방법들입니다:

---

### **1. 요청 수 모니터링**

- 각 노드가 처리하는 요청 수를 실시간으로 모니터링합니다.
- 특정 노드의 요청 수가 전체 평균보다 비정상적으로 높다면 핫스팟 가능성이 높습니다.

**예시:**

- 요청 수 임계값을 설정하고 이를 초과하면 경고를 발생시킴.

---

### **2. 응답 시간 모니터링**

- 각 노드의 응답 시간을 측정하여 비정상적으로 긴 응답을 감지합니다.
- 특정 노드의 응답 시간이 과도하게 늘어나면 과부하 상태일 가능성이 있습니다.

**예시:**

- 평균 응답 시간보다 특정 노드가 일정 비율 이상 느릴 경우 알림.

---

### **3. 자원 사용률 모니터링**

- CPU, 메모리, 네트워크 대역폭 등 노드 자원의 사용률을 추적합니다.
- 특정 노드의 자원 사용률이 다른 노드보다 비정상적으로 높다면 핫스팟입니다.

**예시:**

- CPU 사용률이 80%를 초과하는 노드를 감지.

---

### **4. 데이터 분포 분석**

- 해시 공간에서 각 노드에 할당된 데이터 양을 주기적으로 점검합니다.
- 특정 노드에 데이터가 집중되어 있다면 핫스팟 문제가 발생할 가능성이 있습니다.

**예시:**

- 데이터 크기의 분산을 계산해 불균형이 심한 경우 알림.

---

### **5. 사용자 트래픽 분석**

- 특정 키나 데이터에 집중된 요청이 있는지 분석합니다.
- 인기 있는 데이터가 하나의 노드에 집중적으로 요청되면 핫스팟이 발생합니다.

**예시:**

- 특정 키의 요청 수가 전체 요청의 일정 비율(예: 20%)을 넘으면 경고.

---

### **6. 이상 탐지 알고리즘 활용**

- 머신러닝이나 통계적 기법으로 각 노드의 트래픽이나 자원 사용 패턴에서 비정상적인 변화를 감지합니다.

**예시:**

- 정상 상태 데이터를 학습한 모델이 이상 상태(예: 과도한 요청)일 때 알림.

---

### **감지 후 조치**

- 핫스팟이 감지되면 **로드 밸런싱**, **캐싱 활용**, **노드 증설** 등의 방법으로 트래픽을 분산시켜 문제를 해결할 수 있습니다.
- 실시간 모니터링 도구(예: Prometheus, Grafana)를 통해 이상 패턴을 시각화하고 빠르게 대응하는 것이 중요합니다.